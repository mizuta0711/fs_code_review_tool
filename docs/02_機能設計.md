# 機能設計

## 機能一覧

| No | 機能名 | 優先度 | 説明 |
|----|-------|-------|------|
| F01 | コード入力 | 必須 | テキストエリアへのコード入力 |
| F02 | ドラッグ&ドロップ | 必須 | 複数ファイルのドラッグ&ドロップによる一括入力 |
| F03 | 複数ファイル管理 | 推奨 | 複数ファイルのタブ管理 |
| F04 | AIレビュー実行 | 必須 | 全ファイル一括AIレビュー |
| F05 | レビュー結果表示 | 必須 | コメント追加済みコードの表示 |
| F06 | コピー機能 | 必須 | 結果のクリップボードコピー |
| F07 | ダウンロード機能 | 必須 | 結果のファイルダウンロード |
| F08 | 全ファイル一括DL | 推奨 | 複数ファイルのZIPダウンロード |
| F09 | プロンプト選択 | 必須 | プロンプトテンプレートの選択 |
| F10 | プロンプト管理 | 必須 | プロンプトの追加・編集・削除 |
| F11 | AI切り替え | 必須 | Gemini / Azure OpenAI の切り替え |
| F12 | 設定管理 | 推奨 | API設定の管理 |

---

## F01: コード入力

### 概要
レビュー対象のコードをテキストエリアに入力する。

### 詳細仕様

**入力方法**:
- テキストエリアへの直接入力
- コピー&ペースト
- ドラッグ&ドロップ（F02）

**対応言語**:
- Java（主要ターゲット）
- その他の言語も入力可能（シンタックスハイライトは言語自動判定）

**UI仕様**:
- シンタックスハイライト対応（Monaco Editor または CodeMirror）
- 行番号表示
- ファイル名入力欄（任意）
- 言語選択ドロップダウン（自動判定あり）

**バリデーション**:
- 最大文字数: 100,000文字
- 空のコードではレビュー実行不可

---

## F02: ドラッグ&ドロップ

### 概要
複数ファイルをドラッグ&ドロップで一括入力できる。

### 詳細仕様

**対応ファイル形式**:
- `.java`, `.js`, `.ts`, `.py`, `.c`, `.cpp`, `.cs`, `.go`, `.rb`, `.php`
- テキストファイル全般

**ドロップ時の動作**:
1. ドロップエリアに視覚的フィードバック（ハイライト表示）
2. 各ファイル名をタブ名として設定
3. 各ファイル内容をエディタに読み込み
4. 言語を自動判定
5. 読み込み完了トースト表示

**複数ファイル一括ドロップ**:
- 複数ファイル同時ドロップ対応（必須機能）
- 各ファイルを新規タブとして追加
- 既存のタブが空の場合は最初のファイルで上書き
- 読み込み件数をトースト表示（例: 「3ファイルを読み込みました」）

**エラーハンドリング**:
- バイナリファイル: エラーメッセージ表示（スキップして続行）
- 大きすぎるファイル（10MB超）: エラーメッセージ表示（スキップして続行）
- ファイル数上限超過: 警告表示（最大10ファイルまで読み込み）

---

## F03: 複数ファイル管理

### 概要
複数のソースファイルをタブ形式で管理する。

### 詳細仕様

**タブ操作**:
- タブクリックでファイル切り替え
- [+] ボタンで新規ファイル追加
- [×] ボタンでファイル削除（確認なし、Ctrl+Z で復元不可）
- タブのドラッグ&ドロップによる並び替え

**ファイル情報**:
- ファイル名（編集可能）
- 言語種別
- コード内容

**制限**:
- 最大ファイル数: 10ファイル
- 最小ファイル数: 1ファイル（最後の1つは削除不可）

---

## F04: AIレビュー実行（全ファイル一括）

### 概要
選択したプロンプトを使用して、登録された全ファイルを一括でAIにコードレビューを依頼する。

### 詳細仕様

**一括レビューの特徴**:
- ボタン1回で全ファイルをまとめてレビュー
- ファイル間の関連性も考慮したレビューが可能
- 結果は各ファイルごとにタブで表示

**レビュー実行フロー**:
```
1. 「レビュー実行」ボタンクリック
   ↓
2. 入力バリデーション
   - 少なくとも1ファイルにコードがあるか
   - プロンプトが選択されているか
   ↓
3. ローディング表示開始
   ↓
4. APIにリクエスト送信
   - プロンプト + 全ファイルのコード（一括送信）
   ↓
5. AI処理（Gemini or Azure OpenAI）
   - 全ファイルをまとめて処理
   ↓
6. レスポンス受信
   ↓
7. 各ファイルのレビュー結果を結果エリアにセット
   ↓
8. ローディング表示終了 + 完了トースト
```

**リクエストデータ**:
```typescript
{
  files: [
    {
      name: "Sample.java",
      language: "java",
      content: "public class Sample { ... }"
    },
    // 複数ファイル対応
  ],
  promptId: "prompt-uuid-xxx"
}
```

**レスポンスデータ**:
```typescript
{
  reviewedFiles: [
    {
      name: "Sample.java",
      language: "java",
      content: "// [必須] コメント付きのコード..."
    }
  ],
  summary: "レビューサマリー（任意）",
  provider: "Google AI (Gemini)"
}
```

**複数ファイル時のプロンプト構成**:
```
{プロンプトテンプレート}

--- 以下がレビュー対象のソースコードです ---

=== ファイル: Sample.java ===
{コード内容}

=== ファイル: Main.java ===
{コード内容}

--- レビュー対象ここまで ---
```

**エラーハンドリング**:
- タイムアウト（60秒）: エラーメッセージ + 再試行ボタン
- AI API エラー: エラーメッセージ表示
- ネットワークエラー: エラーメッセージ表示

---

## F05: レビュー結果表示

### 概要
AIが生成したレビューコメント付きコードを表示する。

### 詳細仕様

**表示形式**:
- 入力と同様のタブ形式
- シンタックスハイライト付き
- レビューコメント（`// [必須]`, `// [意見]`, `// [参考]`）をハイライト表示

**コメントハイライト**:
| ラベル | 色 | 説明 |
|-------|-----|------|
| `[必須]` | 赤系 | 必ず修正すべき問題 |
| `[意見]` | 黄系 | 改善提案 |
| `[参考]` | 青系 | 補足情報 |

**表示エリア**:
- 読み取り専用（編集不可）
- 行番号表示
- コピーボタン
- ダウンロードボタン

---

## F06: コピー機能

### 概要
レビュー結果をクリップボードにコピーする。

### 詳細仕様

**コピー対象**:
- 現在表示中のファイルのコード全体

**動作**:
1. 「コピー」ボタンクリック
2. クリップボードにコピー
3. 成功トースト表示（「コピーしました」）

**エラー時**:
- クリップボードアクセス失敗: エラートースト表示

---

## F07: ダウンロード機能

### 概要
レビュー結果をファイルとしてダウンロードする。

### 詳細仕様

**ダウンロード対象**:
- 現在表示中のファイル

**ファイル名**:
- 元のファイル名を使用（例: `Sample.java`）
- ファイル名未設定時は `reviewed_code.txt`

**動作**:
1. 「ダウンロード」ボタンクリック
2. ブラウザ標準のダウンロードダイアログ
3. ファイル保存

---

## F08: 全ファイル一括ダウンロード

### 概要
複数ファイルをZIP形式で一括ダウンロードする。

### 詳細仕様

**対象**:
- レビュー結果の全ファイル

**ZIPファイル名**:
- `reviewed_code_YYYYMMDD_HHMMSS.zip`

**ZIP内構成**:
```
reviewed_code_20241217_143000.zip
├── Sample.java
├── Main.java
└── Utils.java
```

**ライブラリ**:
- JSZip を使用

---

## F09: プロンプト選択

### 概要
レビュー実行時に使用するプロンプトを選択する。

### 詳細仕様

**選択方法**:
- ドロップダウンから選択
- デフォルトプロンプトが初期選択される

**表示内容**:
- プロンプト名
- （ホバー時）説明をツールチップ表示

---

## F10: プロンプト管理

### 概要
プロンプトテンプレートを追加・編集・削除する。

### 詳細仕様

**プロンプト情報**:
| 項目 | 必須 | 説明 |
|-----|------|------|
| ID | 自動 | UUID |
| 名前 | ○ | プロンプト名（最大100文字） |
| 説明 | - | 説明文（最大500文字） |
| 内容 | ○ | プロンプト本文（最大50,000文字） |
| デフォルト | 自動 | デフォルトプロンプトフラグ |
| 作成日時 | 自動 | 作成日時 |
| 更新日時 | 自動 | 更新日時 |

**操作**:
- **追加**: 新規プロンプト作成
- **編集**: 既存プロンプトの編集
- **削除**: プロンプト削除（デフォルトは削除不可）
- **デフォルト設定**: 選択したプロンプトをデフォルトに設定

**初期データ**:
- 「中級編AIコードレビュープロンプト」をデフォルトとして登録

---

## F11: AI切り替え

### 概要
使用するAIプロバイダーを切り替える。

### 詳細仕様

**対応プロバイダー**:
| プロバイダー | 説明 |
|------------|------|
| Google AI (Gemini) | Gemini 2.5 Flash |
| Azure OpenAI | GPT-4o |

**切り替え方法**:
- 設定画面でラジオボタン選択
- 選択後、次回レビューから適用

**環境変数**:
```env
# Gemini
GEMINI_API_KEY=xxx

# Azure OpenAI
AZURE_OPENAI_ENDPOINT=https://xxx.openai.azure.com/
AZURE_OPENAI_API_KEY=xxx
AZURE_OPENAI_DEPLOYMENT=gpt-4o
AZURE_OPENAI_API_VERSION=2024-10-21
```

---

## F12: 設定管理

### 概要
アプリの設定を管理する。

### 詳細仕様

**設定項目**:
| 項目 | 説明 | 保存先 |
|-----|------|-------|
| AIプロバイダー | 使用するAI | ローカルストレージ |
| Gemini API Key | Gemini API キー | ローカルストレージ（暗号化推奨） |
| Azure Endpoint | Azure OpenAI エンドポイント | ローカルストレージ |
| Azure API Key | Azure OpenAI API キー | ローカルストレージ（暗号化推奨） |
| Azure Deployment | Azure OpenAI デプロイ名 | ローカルストレージ |

**優先順位**:
1. 環境変数（サーバーサイド）
2. ローカルストレージ（クライアントサイド）

**セキュリティ考慮**:
- API キーは画面上ではマスク表示
- ローカルストレージへの保存は任意（環境変数推奨の警告表示）

---

## 状態管理

### グローバル状態（Zustand）

```typescript
interface AppState {
  // ファイル管理
  files: CodeFile[];
  activeFileIndex: number;

  // レビュー状態
  isReviewing: boolean;
  reviewedFiles: CodeFile[];
  reviewError: string | null;

  // プロンプト
  selectedPromptId: string | null;

  // 設定
  aiProvider: 'gemini' | 'azure';
}

interface CodeFile {
  id: string;
  name: string;
  language: string;
  content: string;
}
```

---

## 次のステップ

1. [03_API設計.md](./03_API設計.md) - API エンドポイント定義
2. [04_データベース設計.md](./04_データベース設計.md) - データベーススキーマ
