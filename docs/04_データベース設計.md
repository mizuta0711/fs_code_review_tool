# データベース設計

## 概要

### データベース
- **DBMS**: PostgreSQL
- **ホスティング**: Neon
- **ORM**: Prisma

### ER図

```
┌─────────────────────────────────────────┐
│              Prompt                     │
├─────────────────────────────────────────┤
│ id          : String (PK, UUID)         │
│ name        : String                    │
│ description : String?                   │
│ content     : String (Text)             │
│ isDefault   : Boolean                   │
│ createdAt   : DateTime                  │
│ updatedAt   : DateTime                  │
└─────────────────────────────────────────┘
                    │
                    │ 1:N
                    ▼
┌─────────────────────────────────────────┐
│            ReviewHistory                │
│            (将来拡張用)                  │
├─────────────────────────────────────────┤
│ id          : String (PK, UUID)         │
│ promptId    : String (FK)               │
│ inputFiles  : Json                      │
│ outputFiles : Json                      │
│ provider    : String                    │
│ processingTime : Int                    │
│ createdAt   : DateTime                  │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│              Setting                    │
├─────────────────────────────────────────┤
│ id          : String (PK, "default")    │
│ aiProvider  : String                    │
│ updatedAt   : DateTime                  │
└─────────────────────────────────────────┘
```

---

## テーブル定義

### Prompt（プロンプト）

レビュー用プロンプトテンプレートを管理するテーブル。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|----------|------|
| id | VARCHAR(36) | NO | uuid() | プライマリキー（UUID） |
| name | VARCHAR(100) | NO | - | プロンプト名 |
| description | VARCHAR(500) | YES | NULL | 説明 |
| content | TEXT | NO | - | プロンプト内容 |
| isDefault | BOOLEAN | NO | false | デフォルトフラグ |
| createdAt | TIMESTAMP | NO | now() | 作成日時 |
| updatedAt | TIMESTAMP | NO | now() | 更新日時 |

**インデックス**:
- `id` (Primary Key)
- `isDefault` (Index)

**制約**:
- `isDefault = true` は1レコードのみ（アプリケーション側で制御）

---

### Setting（設定）

アプリケーション設定を管理するテーブル。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|----------|------|
| id | VARCHAR(36) | NO | "default" | プライマリキー（固定値） |
| aiProvider | VARCHAR(20) | NO | "gemini" | AIプロバイダー |
| updatedAt | TIMESTAMP | NO | now() | 更新日時 |

**備考**:
- 1レコードのみ存在（シングルトン）
- `id = "default"` で固定

---

### ReviewHistory（レビュー履歴）- 将来拡張用

レビュー実行履歴を保存するテーブル（オプション機能）。

| カラム名 | 型 | NULL | デフォルト | 説明 |
|---------|-----|------|----------|------|
| id | VARCHAR(36) | NO | uuid() | プライマリキー（UUID） |
| promptId | VARCHAR(36) | NO | - | 使用プロンプトID（FK） |
| inputFiles | JSONB | NO | - | 入力ファイル情報 |
| outputFiles | JSONB | NO | - | 出力ファイル情報 |
| provider | VARCHAR(50) | NO | - | 使用AIプロバイダー |
| processingTime | INTEGER | NO | - | 処理時間（ミリ秒） |
| createdAt | TIMESTAMP | NO | now() | 作成日時 |

**備考**:
- MVP では実装しない（将来拡張用）
- ログイン機能追加時にユーザーIDを追加

---

## Prisma スキーマ

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/// プロンプトテンプレート
model Prompt {
  id          String    @id @default(uuid())
  name        String    @db.VarChar(100)
  description String?   @db.VarChar(500)
  content     String    @db.Text
  isDefault   Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // 将来拡張用
  // reviews     ReviewHistory[]

  @@index([isDefault])
}

/// アプリケーション設定
model Setting {
  id          String    @id @default("default")
  aiProvider  String    @default("gemini") @db.VarChar(20)
  updatedAt   DateTime  @updatedAt
}

/// レビュー履歴（将来拡張用）
// model ReviewHistory {
//   id             String   @id @default(uuid())
//   promptId       String
//   prompt         Prompt   @relation(fields: [promptId], references: [id])
//   inputFiles     Json
//   outputFiles    Json
//   provider       String   @db.VarChar(50)
//   processingTime Int
//   createdAt      DateTime @default(now())
//
//   @@index([promptId])
//   @@index([createdAt])
// }
```

---

## 初期データ（シード）

### Prompt 初期データ

```typescript
// prisma/seed.ts

import { PrismaClient } from '@prisma/client';
import fs from 'fs';
import path from 'path';

const prisma = new PrismaClient();

async function main() {
  // 中級編AIコードレビュープロンプトを読み込み
  const promptContent = fs.readFileSync(
    path.join(__dirname, '../docs/中級編AIコードレビュープロンプト.txt'),
    'utf-8'
  );

  // デフォルトプロンプト作成
  await prisma.prompt.upsert({
    where: { id: 'default-prompt' },
    update: {},
    create: {
      id: 'default-prompt',
      name: '中級編AIコードレビュープロンプト',
      description: 'Java初級者向けの詳細なレビュー観点を含むプロンプト',
      content: promptContent,
      isDefault: true,
    },
  });

  // 設定の初期化
  await prisma.setting.upsert({
    where: { id: 'default' },
    update: {},
    create: {
      id: 'default',
      aiProvider: 'gemini',
    },
  });

  console.log('Seed completed');
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

---

## マイグレーション手順

### 初回セットアップ

```bash
# 1. 環境変数設定
# .env.local に DATABASE_URL を設定

# 2. マイグレーション実行
npx prisma migrate dev --name init

# 3. シードデータ投入
npx prisma db seed
```

### 本番環境デプロイ

```bash
# 1. マイグレーション実行
npx prisma migrate deploy

# 2. Prismaクライアント生成
npx prisma generate
```

---

## 環境変数

```env
# .env.local

# Neon PostgreSQL 接続文字列
DATABASE_URL="postgresql://user:password@ep-xxx.region.aws.neon.tech/dbname?sslmode=require"
```

---

## データ整合性

### デフォルトプロンプトの制約

**ルール**:
- `isDefault = true` のレコードは常に1つのみ
- デフォルトプロンプトは削除不可
- 新しいデフォルト設定時、既存のデフォルトを解除

**実装**:
```typescript
// プロンプトをデフォルトに設定
async function setDefaultPrompt(promptId: string) {
  await prisma.$transaction([
    // 既存のデフォルトを解除
    prisma.prompt.updateMany({
      where: { isDefault: true },
      data: { isDefault: false },
    }),
    // 新しいデフォルトを設定
    prisma.prompt.update({
      where: { id: promptId },
      data: { isDefault: true },
    }),
  ]);
}
```

---

## バックアップ・リカバリ

### Neon の機能を利用

- **Point-in-time recovery**: 過去の任意の時点に復元可能
- **Branching**: 開発用ブランチの作成

### 手動バックアップ

```bash
# データエクスポート
pg_dump $DATABASE_URL > backup.sql

# データインポート
psql $DATABASE_URL < backup.sql
```

---

## 将来の拡張

### ユーザー機能追加時

```prisma
model User {
  id        String    @id @default(uuid())
  email     String    @unique
  name      String?
  prompts   Prompt[]
  reviews   ReviewHistory[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Prompt {
  // 既存フィールド...
  userId    String?
  user      User?     @relation(fields: [userId], references: [id])
}
```

### レビュー履歴機能追加時

- `ReviewHistory` モデルのコメントアウトを解除
- Prompt との関連を有効化

---

## 次のステップ

設計書の作成が完了しました。以下の順序で実装を進めることを推奨します：

1. **フェーズ1: 基盤構築**
   - Prisma スキーマ作成
   - データベース接続
   - シードデータ投入

2. **フェーズ2: API実装**
   - プロンプト CRUD API
   - 設定 API
   - レビュー実行 API

3. **フェーズ3: フロントエンド実装**
   - メイン画面（コード入力・結果表示）
   - プロンプト管理画面
   - 設定画面

4. **フェーズ4: AI統合**
   - Gemini クライアント実装
   - Azure OpenAI クライアント実装
   - プロバイダー切り替え機能

5. **フェーズ5: 機能拡張**
   - 複数ファイル対応
   - ドラッグ&ドロップ
   - ZIP ダウンロード
